{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h3>Holidays</h3>
    
    <!-- Add Holiday Form -->
    <form method="POST" class="row g-3 mb-3">
        <div class="col-auto">
            <input class="form-control" name="date" type="date" required>
        </div>
        <div class="col-auto">
            <input class="form-control" name="name" placeholder="Holiday name" required>
        </div>
        <div class="col-auto">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_default" id="isDefault">
                <label class="form-check-label" for="isDefault">
                    Add as default holiday
                </label>
            </div>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Add</button>
        </div>
    </form>

    <!-- Default Holidays Table -->
    <h4>Default Holidays</h4>
    <table id="defaultHolidaysTable" class="display table table-hover">
        <thead>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for date, name in defaults.items() %}
            <tr data-date="{{ date }}">
                <td>{{ date }}</td>
                <td class="holiday-name">{{ name }}</td>
                <td>
                    <form method="POST" action="{{ url_for('admin_holidays_remove') }}" style="display: inline;">
                        <input type="hidden" name="date" value="{{ date }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this holiday?')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Custom Holidays Table -->
    <h4 class="mt-4">Custom Holidays</h4>
    <table id="customHolidaysTable" class="display table table-hover">
        <thead>
            <tr>
                <th>Year</th>
                <th>Date</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for year, holidays in annual_holidays.items() %}
                {% if year != "defaults" %}
                    {% for date, name in holidays.items() %}
                    <tr data-date="{{ date }}">
                        <td>{{ year }}</td>
                        <td>{{ date }}</td>
                        <td class="holiday-name">{{ name }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_holidays_remove') }}" style="display: inline;">
                                <input type="hidden" name="date" value="{{ date }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this holiday?')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </td>
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
$(document).ready(function() {
    // Initialize DataTables
    $('#defaultHolidaysTable').DataTable({
        order: [[0, 'asc']],
        pageLength: 10
    });
    $('#customHolidaysTable').DataTable({
        order: [[0, 'asc'], [1, 'asc']],
        pageLength: 10
    });
});
        const currentName = nameCell.text();
        
        const input = $('<input>')
            .attr('type', 'text')
            .addClass('form-control form-control-sm')
            .val(currentName);
            
        nameCell.html(input);
        input.focus();
        
        input.on('keypress blur', function(e) {
            if (e.type === 'blur' || e.key === 'Enter') {
                e.preventDefault();
                const newName = input.val().trim();
                const date = row.data('date');
                
                $.post('/admin/holidays/edit', {
                    date: date,
                    name: newName
                })
                .done(function() {
                    nameCell.text(newName);
                })
                .fail(function() {
                    nameCell.text(currentName);
                    alert('Failed to update holiday');
                });
            }
        });
    });

    // Delete Holiday
    $('.delete-holiday').click(function() {
        if (!confirm('Are you sure you want to delete this holiday?')) return;
        
        const row = $(this).closest('tr');
        const date = row.data('date');
        
        $.post('/admin/holidays/delete', {
            date: date
        })
        .done(function() {
            row.remove();
        })
        .fail(function() {
            alert('Failed to delete holiday');
        });
    });

    // Make Default
    $('.make-default').click(function() {
        const row = $(this).closest('tr');
        const date = row.data('date');
        
        $.post('/admin/holidays/make-default', {
            date: date
        })
        .done(function() {
            // Move the row to default holidays table
            const defaultTable = $('#defaultHolidaysTable').DataTable();
            const rowData = row.find('td').map(function() {
                return $(this).text();
            }).get();
            defaultTable.row.add(rowData).draw();
            row.remove();
        })
        .fail(function() {
            alert('Failed to set as default');
        });
    });
});
</script>

<style>
.holiday-name {
    cursor: pointer;
}
.btn-sm {
    margin: 0 2px;
}
</style>
{% endblock %}